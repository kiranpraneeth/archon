# Claude Code Review Action
#
# Automatically reviews pull requests using Claude Code CLI.
#
# REQUIREMENTS:
# 1. ANTHROPIC_API_KEY secret must be set in repo settings
#    Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
#
# 2. Claude Code CLI installation is handled by this workflow
#    Uses: npm install -g @anthropic-ai/claude-code
#
# SECURITY:
# - Only runs on PRs from the same repo (not forks) to protect secrets
# - Uses pull_request_target to run workflow from base branch
# - Secrets are never exposed to untrusted PR code
# - Consider using a dedicated API key with spend limits for CI
#
# NOTES:
# - Reviews only changed files in the PR
# - Posts review as a PR comment
# - Failures are non-blocking (won't fail the PR)

name: Claude Code Review

on:
  pull_request_target:
    types: [opened, synchronize]

# Prevent concurrent reviews on the same PR
concurrency:
  group: code-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Review PR
    runs-on: ubuntu-latest
    # Don't fail the PR if review fails
    continue-on-error: true

    # Security: Only run on PRs from the same repo (not forks)
    # This prevents malicious fork PRs from accessing secrets
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      vars.ENABLE_CLAUDE_REVIEW != 'false'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Fetch PR head for diff
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-head
          git checkout pr-head

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in PR (compare base branch to PR head)
          FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...pr-head | grep -E '\.(ts|tsx|js|jsx|py|go|rs|java)$' || true)

          if [ -z "$FILES" ]; then
            echo "No reviewable files changed"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$FILES"
            # Store as single line for passing to claude
            FILES_INLINE=$(echo "$FILES" | tr '\n' ' ')
            echo "files=$FILES_INLINE" >> $GITHUB_OUTPUT
            echo "has_files=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        id: review
        if: steps.changed-files.outputs.has_files == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create review prompt
          REVIEW_PROMPT="You are the Code Review Agent for Archon. Review the following files that changed in this PR.

          Load the review philosophy from .claude/agents/reviewer/CLAUDE.md if it exists.

          Changed files: ${{ steps.changed-files.outputs.files }}

          Instructions:
          1. Read each changed file
          2. Provide a code review following the standard format:
             - Summary (Approve / Request Changes / Needs Discussion)
             - Overview (2-3 sentences)
             - Feedback grouped by severity (ðŸ”´ Blockers, ðŸŸ¡ Suggestions, ðŸŸ¢ Nitpicks)
             - What I Liked
             - Questions (if any)
          3. Be constructive and specific
          4. Focus on bugs, security issues, and code quality

          Review the changes now."

          # Run Claude Code in print mode (non-interactive)
          # Capture output, handle potential failures
          set +e
          REVIEW_OUTPUT=$(echo "$REVIEW_PROMPT" | claude --print --output-format text 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Claude Code failed with exit code $EXIT_CODE"
            echo "Output: $REVIEW_OUTPUT"
            REVIEW_OUTPUT="âš ï¸ Code review could not be completed. Please review manually.

          Error details:
          \`\`\`
          $REVIEW_OUTPUT
          \`\`\`"
          fi

          # Save review to file (handles multi-line output)
          echo "$REVIEW_OUTPUT" > review_output.md

          # Set output for next step
          echo "review_complete=true" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.review.outputs.review_complete == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read review output
            let reviewBody = fs.readFileSync('review_output.md', 'utf8');

            // Add header and footer
            const shortSha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);
            const comment = `## ðŸ¤– Claude Code Review

            ${reviewBody}

            ---
            <sub>Generated by [Claude Code](https://claude.ai/code) â€¢ Reviewed commit ${shortSha}</sub>`;

            // Find existing bot comment to update (avoid spam)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ¤– Claude Code Review')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new review comment');
            }

      - name: Skip review (no files)
        if: steps.changed-files.outputs.has_files == 'false'
        run: echo "No reviewable source files changed. Skipping review."
